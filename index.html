<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Factory</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* DESIGN SOMBRE √âPUR√â */
        :root {
            --bg-dark: #202225;
            --bg-medium: #2f3136;
            --bg-light: #36393f;
            --primary: #5865F2;
            --text: #dcddde;
            --green: #3ba55c;
            --red: #ed4245;
        }
        
        body { margin: 0; font-family: sans-serif; background: var(--bg-medium); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        /* LOGIN SCREEN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .login-box { background: var(--bg-light); padding: 30px; border-radius: 8px; width: 300px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        input { width: 100%; padding: 10px; margin: 10px 0; background: var(--bg-dark); border: 1px solid #202225; color: white; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 5px; }
        button:hover { opacity: 0.9; }
        .switch-btn { background: transparent; color: var(--primary); margin-top: 10px; font-size: 0.9em; }

        /* APP LAYOUT */
        #app { display: none; width: 100%; height: 100%; }
        
        /* SIDEBAR (LISTE DES TICKETS) */
        .sidebar { width: 300px; background: var(--bg-dark); display: flex; flex-direction: column; border-right: 1px solid #1e1f22; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #2f3136; background: #18191c; }
        .role-badge { font-size: 0.7em; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-weight: bold; margin-left: 5px; }
        .role-admin { background: var(--red); color: white; }
        .role-support { background: var(--green); color: white; }
        .role-user { background: var(--primary); color: white; }

        .ticket-list { flex: 1; overflow-y: auto; padding: 10px; }
        .ticket-item { padding: 12px; margin-bottom: 5px; background: var(--bg-medium); border-radius: 4px; cursor: pointer; border-left: 3px solid var(--primary); }
        .ticket-item:hover { background: #40444b; }
        .ticket-item.active { background: #40444b; border-left-color: white; }
        .ticket-item small { color: #72767d; display: block; margin-top: 4px; }

        /* CHAT AREA */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: var(--bg-light); }
        .chat-header { height: 60px; border-bottom: 1px solid #2f3136; display: flex; align-items: center; padding: 0 20px; font-weight: bold; font-size: 1.2em; justify-content: space-between; }
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        .msg { padding: 10px 15px; border-radius: 8px; max-width: 70%; line-height: 1.4; }
        .msg.self { align-self: flex-end; background: var(--primary); color: white; }
        .msg.other { align-self: flex-start; background: var(--bg-medium); }
        .msg-info { font-size: 0.75em; margin-bottom: 4px; opacity: 0.7; font-weight: bold; }
        
        .input-area { padding: 20px; background: var(--bg-light); border-top: 1px solid #2f3136; display: flex; gap: 10px; }
        
        /* ADMIN PANEL */
        .admin-panel { background: #2d2f35; padding: 15px; margin-top: auto; border-top: 1px solid #1e1f22; }
        .admin-title { font-size: 0.8em; color: #aaa; text-transform: uppercase; margin-bottom: 10px; display: block; font-weight: bold; }

    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 id="login-title">Connexion</h2>
            <input type="text" id="username" placeholder="Identifiant">
            <input type="password" id="password" placeholder="Mot de passe">
            <button onclick="login()">Entrer</button>
            <button class="switch-btn" onclick="toggleRegister()" id="toggle-btn">Pas de compte ? Cr√©er un compte</button>
        </div>
    </div>

    <div id="app">
        <div class="sidebar">
            <div class="sidebar-header">
                <div style="font-size: 1.2em; font-weight: bold;">Support Factory</div>
                <div style="margin-top: 5px; font-size: 0.9em; color: #aaa;">
                    Connect√©: <span id="current-user-display" style="color:white;"></span>
                </div>
                <button onclick="logout()" style="background:#2f3136; margin-top:10px; font-size:0.8em;">D√©connexion</button>
            </div>
            
            <div style="padding:10px;">
                <button onclick="createNewTicket()" style="background:var(--green);">+ Nouveau Ticket</button>
            </div>

            <div class="ticket-list" id="ticket-list">
                </div>

            <div id="admin-zone" class="admin-panel" style="display:none;">
                <span class="admin-title">üîí ADMIN PANEL (Ajout Support)</span>
                <input type="text" id="new-support-name" placeholder="Nom du support" style="font-size:0.8em; margin:2px 0;">
                <input type="password" id="new-support-pass" placeholder="Mot de passe" style="font-size:0.8em; margin:2px 0;">
                <button onclick="addSupportMember()" style="background:var(--primary); font-size:0.8em;">Ajouter au Staff</button>
            </div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <span id="chat-title">S√©lectionnez un ticket</span>
                <span id="ticket-id-display" style="font-size:0.6em; color:#72767d;"></span>
            </div>
            <div class="messages" id="messages">
                </div>
            <div class="input-area" id="input-area" style="display:none;">
                <input type="text" id="msg-input" placeholder="√âcrivez votre message..." onkeypress="if(event.key==='Enter') sendMsg()">
                <button onclick="sendMsg()" style="width: 80px;">Envoyer</button>
            </div>
        </div>
    </div>

    <script>
        // --- BASE DE DONN√âES LOCALE ---
        // On initialise avec le compte admin _jojo_fr s'il n'existe pas
        let DB = JSON.parse(localStorage.getItem('sf_db')) || {
            users: [
                { user: '_jojo_fr', pass: '2516', role: 'admin' } // Compte Admin pr√©-cr√©√©
            ],
            tickets: []
        };

        let currentUser = null;
        let currentTicketId = null;
        let isRegistering = false;

        function save() { localStorage.setItem('sf_db', JSON.stringify(DB)); }

        // --- AUTHENTIFICATION ---
        function toggleRegister() {
            isRegistering = !isRegistering;
            document.getElementById('login-title').innerText = isRegistering ? "Inscription Membre" : "Connexion";
            document.getElementById('toggle-btn').innerText = isRegistering ? "Retour Connexion" : "Pas de compte ? Cr√©er un compte";
        }

        function login() {
            const userIn = document.getElementById('username').value.trim();
            const passIn = document.getElementById('password').value.trim();

            if (!userIn || !passIn) return alert('Champs vides !');

            if (isRegistering) {
                if (DB.users.find(u => u.user === userIn)) return alert('Utilisateur d√©j√† pris !');
                DB.users.push({ user: userIn, pass: passIn, role: 'member' });
                save();
                alert('Compte cr√©√© ! Connectez-vous.');
                toggleRegister();
            } else {
                const found = DB.users.find(u => u.user === userIn && u.pass === passIn);
                if (found) {
                    currentUser = found;
                    initApp();
                } else {
                    alert('Identifiants incorrects.');
                }
            }
        }

        function logout() { location.reload(); }

        // --- FONCTION ADMIN (Ajout Support) ---
        function addSupportMember() {
            // S√©curit√© : Seul _jojo_fr peut faire √ßa (v√©rifi√© aussi visuellement)
            if (currentUser.role !== 'admin') return; 

            const name = document.getElementById('new-support-name').value;
            const pass = document.getElementById('new-support-pass').value;

            if(!name || !pass) return alert("Remplir nom et mot de passe");
            
            DB.users.push({ user: name, pass: pass, role: 'support' });
            save();
            alert(`‚úÖ ${name} ajout√© √† l'√©quipe Support !`);
            document.getElementById('new-support-name').value = '';
            document.getElementById('new-support-pass').value = '';
        }

        // --- LOGIQUE APPLICATION ---
        function initApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            
            // Affichage badges
            let badgeColor = currentUser.role === 'admin' ? 'red' : (currentUser.role === 'support' ? 'green' : 'gray');
            let badgeText = currentUser.role.toUpperCase();
            document.getElementById('current-user-display').innerHTML = 
                `${currentUser.user} <span class="role-badge" style="background:${badgeColor}">${badgeText}</span>`;

            // Afficher le panneau admin SEULEMENT pour _jojo_fr
            if (currentUser.role === 'admin') {
                document.getElementById('admin-zone').style.display = 'block';
            }

            renderTickets();
        }

        function createNewTicket() {
            const subject = prompt("Sujet du ticket (ex: Bug Boutique):");
            if (!subject) return;

            const newTicket = {
                id: Date.now(),
                creator: currentUser.user,
                subject: subject,
                messages: [] // Messages vides au d√©but
            };
            
            // Message syst√®me auto
            newTicket.messages.push({
                sender: 'Syst√®me',
                role: 'bot',
                text: `Ticket "${subject}" cr√©√© par ${currentUser.user}. Un membre du staff va r√©pondre.`
            });

            DB.tickets.push(newTicket);
            save();
            renderTickets();
            openTicket(newTicket.id);
        }

        function renderTickets() {
            const list = document.getElementById('ticket-list');
            list.innerHTML = '';

            // FILTRE : 
            // - Membre : voit SES tickets
            // - Support/Admin : voient TOUS les tickets
            let myTickets = [];
            if (currentUser.role === 'member') {
                myTickets = DB.tickets.filter(t => t.creator === currentUser.user);
            } else {
                myTickets = DB.tickets; // Voir tout
            }

            if(myTickets.length === 0) list.innerHTML = '<div style="padding:10px; color:#777;">Aucun ticket.</div>';

            myTickets.forEach(t => {
                const div = document.createElement('div');
                div.className = `ticket-item ${currentTicketId === t.id ? 'active' : ''}`;
                div.onclick = () => openTicket(t.id);
                div.innerHTML = `
                    <div><strong>${t.subject}</strong></div>
                    <small>Par: ${t.creator}</small>
                `;
                list.appendChild(div);
            });
        }

        function openTicket(id) {
            currentTicketId = id;
            renderTickets(); // Pour mettre √† jour la classe "active"
            document.getElementById('input-area').style.display = 'flex';
            
            const ticket = DB.tickets.find(t => t.id === id);
            document.getElementById('chat-title').innerText = ticket.subject;
            document.getElementById('ticket-id-display').innerText = "ID: " + ticket.id;

            renderMessages(ticket);
        }

        function renderMessages(ticket) {
            const container = document.getElementById('messages');
            container.innerHTML = '';

            ticket.messages.forEach(msg => {
                const div = document.createElement('div');
                const isMe = msg.sender === currentUser.user;
                div.className = `msg ${isMe ? 'self' : 'other'}`;
                
                // Couleur du nom selon le r√¥le (approximatif pour l'historique)
                let roleColor = '#aaa'; 
                if(msg.role === 'admin') roleColor = '#ed4245';
                if(msg.role === 'support') roleColor = '#3ba55c';
                
                div.innerHTML = `
                    <div class="msg-info" style="color:${roleColor}">${msg.sender}</div>
                    ${msg.text}
                `;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        }

        function sendMsg() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text || !currentTicketId) return;

            const ticket = DB.tickets.find(t => t.id === currentTicketId);
            ticket.messages.push({
                sender: currentUser.user,
                role: currentUser.role,
                text: text
            });
            
            save();
            input.value = '';
            renderMessages(ticket);
        }
    </script>
</body>
</html>
